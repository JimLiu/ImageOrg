//
//  VideoThumbnailFactory.swift
//  imageorg
//
//  Created by Finn Schlenk on 06.01.19.
//  Copyright Â© 2019 Finn Schlenk. All rights reserved.
//

import Cocoa
import AVKit

class VideoThumbnailFactory: ThumbnailFactory {

    static var size = NSSize(width: 460, height: 360)
    static var quality: Float = 0.7

    var localFileManager = LocalFileManager()
    var thumbnailCoreDataService = ThumbnailCoreDataService()

    func createThumbnailImage(from filePath: String, completionHandler handler: @escaping (Result<NSImage, ThumbnailError>) -> ()) {
        DispatchQueue.global(qos: .userInitiated).async {
            let asset = AVAsset(url: URL(fileURLWithPath: filePath))
            let imageGenerator = AVAssetImageGenerator(asset: asset)
            let time = CMTime(seconds: 1, preferredTimescale: 1)
            var thumbnailImage: NSImage?

            do {
                let imageRef = try imageGenerator.copyCGImage(at: time, actualTime: nil)
                let frame = NSImage(cgImage: imageRef, size: NSZeroSize)
                thumbnailImage = frame.resized(to: VideoThumbnailFactory.size)
            } catch {
                handler(.failure(.notCreated))
            }

            handler(.success(thumbnailImage!))
        }
    }
}
